[options]
# =============================================================================
# Database Configuration
# =============================================================================
db_host = ${DB_HOST}
db_port = ${DB_PORT}
db_user = ${DB_USER}
db_password = ${DB_PASSWORD}

# Multi-database mode: False = show database selector, allow multiple DBs
# Set to specific DB name to skip selector and default to that DB
db_name = ${DB_NAME}

# Use template0 (not template1) - Odoo official recommendation
# - Blocks connections during creation (safer)
# - Allows any encoding/locale choice
# - Pristine state without local additions
db_template = template0

db_maxconn = ${ODOO_DB_MAXCONN}
db_sslmode = ${ODOO_DB_SSLMODE}
db_sslrootcert = false

# Filter databases by pattern - excludes odoo_sessions (session storage only)
dbfilter = ^odoo_(?!sessions$).*$

# Connection Pool Settings (for Neon serverless PostgreSQL)
db_maxconn_gevent = ${ODOO_DB_MAXCONN_GEVENT}
db_statement_timeout = 300000

# =============================================================================
# Server Configuration
# =============================================================================
http_port = 8069
http_interface = 0.0.0.0
proxy_mode = true
trusted_proxy_ips = *

# Paths
addons_path = /usr/lib/python3/dist-packages/odoo/addons,/mnt/extra-addons
data_dir = /var/lib/odoo

# =============================================================================
# Development Mode (Doppler: ODOO_DEV_MODE)
# =============================================================================
# Enable debug mode and auto-reload for development
# Options: False (production) | True (enable debug)
# For auto-reload add: reload,xml,qweb (requires watchdog: pip install watchdog)
# Doppler values: "False" (prod), "True" (dev), "reload,xml,qweb" (dev with auto-reload)
debug_mode = ${ODOO_DEBUG_MODE}
dev_mode = ${ODOO_DEV_MODE}

# =============================================================================
# Logging Configuration
# =============================================================================
log_level = ${ODOO_LOG_LEVEL}
# Development: :DEBUG,werkzeug:INFO,odoo.modules.loading:DEBUG
# Production: :INFO,gevent.pywsgi:ERROR,werkzeug:WARNING
log_handler = ${ODOO_LOG_HANDLER}

# Optional: Log to file (Doppler: ODOO_LOGFILE)
# Development: /var/log/odoo/odoo.log | Production: False (stdout)
logfile = ${ODOO_LOGFILE}
logrotate = ${ODOO_LOGROTATE}

# Log SQL queries to DB (WARNING: performance impact)
log_db = ${ODOO_LOG_DB}

# =============================================================================
# Workers Configuration (CRITICAL for template creation)
# =============================================================================
# IMPORTANT: Set ODOO_WORKERS=0 when creating template database
# Multi-workers cause serialization failures during base module init
# Development: 0 (easier debugging) | Production: (CPU * 2) + 1
workers = ${ODOO_WORKERS}
max_cron_threads = ${ODOO_MAX_CRON_THREADS}
gevent_port = 8072
longpolling_port = 8072

# =============================================================================
# Security
# =============================================================================
admin_passwd = ${ODOO_ADMIN_PASSWORD}
list_db = ${ODOO_LIST_DB}
csrf_protection = ${ODOO_CSRF_PROTECTION}

# Server-wide modules
server_wide_modules = base,web,sentry,auth_api_key,session_db,dbfilter_from_header,safee_db_manager,bus_alt_connection

# Bus alt connection - direct PostgreSQL for LISTEN/NOTIFY (bypasses PgBouncer)
imdispatcher_db_host = ${IMDISPATCHER_DB_HOST}
imdispatcher_db_port = ${IMDISPATCHER_DB_PORT}

# =============================================================================
# Performance Limits
# =============================================================================
limit_memory_hard = ${ODOO_LIMIT_MEMORY_HARD}
limit_memory_soft = ${ODOO_LIMIT_MEMORY_SOFT}
limit_request = ${ODOO_LIMIT_REQUEST}
limit_time_cpu = ${ODOO_LIMIT_TIME_CPU}
limit_time_real = ${ODOO_LIMIT_TIME_REAL}
limit_time_real_cron = -1

# =============================================================================
# Database Features (Doppler: ODOO_UNACCENT)
# =============================================================================
# Enable unaccent for better search (requires PostgreSQL unaccent extension)
# Development/Production: True | Default: False
unaccent = ${ODOO_UNACCENT}

# =============================================================================
# Testing (Doppler: ODOO_TEST_ENABLE)
# =============================================================================
# Enable tests during module install/update
# Development: True | Production: False
test_enable = ${ODOO_TEST_ENABLE}

# =============================================================================
# Productivity Apps
# =============================================================================
# Don't auto-install productivity apps - we manage modules explicitly
# We install specific modules in template.service.ts instead
default_productivity_apps = False

# Sentry Error Tracking
sentry_enabled = ${SENTRY_ENABLED}
sentry_dsn = ${SENTRY_DSN}
sentry_environment = ${SENTRY_ENVIRONMENT}
sentry_logging_level = warn
sentry_exclude_loggers = werkzeug,gevent,gevent.pywsgi
sentry_ignore_exceptions = odoo.exceptions.AccessDenied,odoo.exceptions.AccessError,odoo.exceptions.MissingError,odoo.exceptions.RedirectWarning,odoo.exceptions.UserError,odoo.exceptions.ValidationError,odoo.exceptions.Warning,odoo.exceptions.except_orm
sentry_include_context = true
sentry_odoo_dir = /usr/lib/python3/dist-packages/odoo

# R2 Cloud Storage
[fs_storage.r2_odoo]
protocol = s3
options = {"endpoint_url": "${R2_ENDPOINT}", "key": "${R2_ACCESS_KEY_ID}", "secret": "${R2_SECRET_ACCESS_KEY}"}
directory_path = ${R2_BUCKET_UPLOADS}/odoo
